# F.A.I.L. Kit GitLab CI Configuration
# Forensic Audit of Intelligent Logic
#
# Add this to your repository as .gitlab-ci.yml or include it
#
# Security & Performance Optimizations Applied:
# - Pinned Docker image versions (prevents supply chain attacks)
# - Job timeouts (prevent zombie jobs)
# - Parallel matrix testing (Node.js 18.x and 20.x)
# - Dependency caching (faster builds)

# Default settings
default:
  timeout: 15 minutes  # Prevent zombie jobs

# Cache configuration for faster builds
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - .npm/

# F.A.I.L. Kit Audit Job Template
.fail-audit:
  # Pinned image version - prevents supply chain attacks
  image: node:20.10.0-alpine3.19
  stage: test
  variables:
    FAIL_AUDIT_FORMAT: "json"
    FAIL_AUDIT_STRICT: "false"
    NPM_CONFIG_CACHE: "${CI_PROJECT_DIR}/.npm"
  before_script:
    - npm ci --cache .npm --prefer-offline --silent
    - npm install -g @fail-kit/cli
  script:
    - |
      # Run the forensic audit
      fail-audit run \
        --format ${FAIL_AUDIT_FORMAT} \
        --output audit-results.json \
        --ci || AUDIT_EXIT_CODE=$?
      
      # Generate HTML dashboard
      fail-audit report audit-results.json \
        --format html \
        --output audit-dashboard.html
      
      # Generate JUnit report for GitLab integration
      fail-audit report audit-results.json \
        --format junit \
        --output audit-results-junit.xml
      
      # Post to MR if applicable
      if [ -n "$CI_MERGE_REQUEST_IID" ]; then
        node -e "
          const fs = require('fs');
          const https = require('https');
          
          const results = JSON.parse(fs.readFileSync('audit-results.json', 'utf8'));
          const passed = results.passed;
          const failed = results.failed;
          const total = results.total;
          const passRate = ((passed / total) * 100).toFixed(1);
          
          // Build comment
          let status = parseFloat(passRate) >= 95 ? 'PASS' : 'NEEDS REVIEW';
          let emoji = status === 'PASS' ? 'âœ…' : 'âš ï¸';
          
          const criticalFailures = results.results.filter(r => 
            !r.pass && (r.case.includes('CONTRACT_0003') || r.case.includes('CONTRACT_02'))
          );
          
          if (criticalFailures.length > 0) {
            status = 'BLOCK';
            emoji = 'ðŸš«';
          }
          
          let body = '## ' + emoji + ' F.A.I.L. Kit Audit: ' + status + '\n\n';
          body += '| Metric | Value |\n|--------|-------|\n';
          body += '| **Pass Rate** | ' + passRate + '% (' + passed + '/' + total + ') |\n';
          body += '| **Critical** | ' + criticalFailures.length + ' |\n';
          body += '| **Duration** | ' + (results.duration_ms / 1000).toFixed(2) + 's |\n\n';
          
          if (failed > 0) {
            body += '<details><summary>View ' + failed + ' failure(s)</summary>\n\n';
            body += '| Test | Reason |\n|------|--------|\n';
            results.results.filter(r => !r.pass).slice(0, 10).forEach(f => {
              const reason = (f.reason || f.error || 'Failed').substring(0, 40);
              body += '| \`' + f.case + '\` | ' + reason + ' |\n';
            });
            body += '\n</details>\n';
          }
          
          body += '\n---\n<sub>Generated by F.A.I.L. Kit â€¢ Pipeline: ' + process.env.CI_PIPELINE_ID + '</sub>';
          
          // Post to GitLab MR
          const projectId = process.env.CI_PROJECT_ID;
          const mrIid = process.env.CI_MERGE_REQUEST_IID;
          const token = process.env.GITLAB_TOKEN || process.env.CI_JOB_TOKEN;
          
          const postData = JSON.stringify({ body });
          
          const options = {
            hostname: 'gitlab.com',
            path: '/api/v4/projects/' + projectId + '/merge_requests/' + mrIid + '/notes',
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'PRIVATE-TOKEN': token,
              'Content-Length': Buffer.byteLength(postData)
            }
          };
          
          const req = https.request(options, (res) => {
            console.log('Posted MR comment: ' + res.statusCode);
          });
          
          req.on('error', (e) => console.error('Failed to post comment: ' + e.message));
          req.write(postData);
          req.end();
        "
      fi
      
      # Exit with audit code if strict mode
      if [ \"$FAIL_AUDIT_STRICT\" = \"true\" ] && [ -n \"$AUDIT_EXIT_CODE\" ]; then
        exit $AUDIT_EXIT_CODE
      fi
  artifacts:
    paths:
      - audit-results.json
      - audit-dashboard.html
    reports:
      junit: audit-results-junit.xml
    expire_in: 30 days
    when: always
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Parallel matrix testing for Node.js compatibility
.fail-audit-matrix:
  extends: .fail-audit
  parallel:
    matrix:
      - NODE_VERSION: ["18", "20"]
  image: node:${NODE_VERSION}-alpine

# Example usage in your .gitlab-ci.yml:
#
# include:
#   - remote: 'https://raw.githubusercontent.com/resetroot99/The-FAIL-Kit/main/cli/templates/gitlab-ci.yml'
#
# stages:
#   - test
#   - audit
#
# fail-audit:
#   extends: .fail-audit
#   stage: audit
#   needs: []  # Run in parallel with other jobs
#   variables:
#     FAIL_AUDIT_STRICT: "true"  # Fail pipeline on critical issues

# Full job definition for copy-paste
fail-audit:
  extends: .fail-audit
  stage: test
  allow_failure: true  # Set to false to block MRs on failures

# Strict audit job - blocks MRs on critical failures
fail-audit-strict:
  extends: .fail-audit
  stage: test
  variables:
    FAIL_AUDIT_STRICT: "true"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always
    - when: never
