# F.A.I.L. Kit GitHub Action
# Forensic Audit of Intelligent Logic
#
# Add this to your repository as .github/workflows/fail-audit.yml
#
# Security Optimizations Applied:
# - Immutable action references (commit SHAs instead of version tags)
# - Principle of least privilege (minimal permissions)
# - Execution timeouts (prevent zombie jobs)

name: F.A.I.L. Kit Audit

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, master]

# Principle of least privilege - only request permissions actually needed
permissions:
  contents: read
  pull-requests: write
  checks: write
  statuses: write

jobs:
  audit:
    name: Forensic Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Prevent zombie jobs
    
    # Parallel matrix testing for Node.js compatibility
    strategy:
      matrix:
        node-version: [18.x, 20.x]
      fail-fast: true  # Cancel all jobs if one fails
    
    steps:
      # Immutable action references - prevents supply chain attacks
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'  # Dependency caching for faster builds

      - name: Install dependencies
        run: npm ci

      # Optional: Start your agent server if needed for testing
      # - name: Start Agent Server
      #   run: npm run start:test &
      #   env:
      #     NODE_ENV: test

      - name: Install F.A.I.L. Kit CLI
        run: npm install -g @fail-kit/cli

      - name: Run Audit
        id: audit
        run: |
          # Run the audit and capture results
          fail-audit run --format json --output audit-results.json --ci || echo "AUDIT_FAILED=true" >> $GITHUB_OUTPUT
          
          # Generate HTML dashboard
          fail-audit report audit-results.json --format html --output audit-dashboard.html
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post PR Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('audit-results.json', 'utf8'));
            
            const passed = results.passed;
            const failed = results.failed;
            const total = results.total;
            const passRate = ((passed / total) * 100).toFixed(1);
            
            // Determine status
            const criticalFailures = results.results.filter(r => 
              !r.pass && (
                r.case.includes('CONTRACT_0003') || 
                r.case.includes('CONTRACT_02') ||
                r.case.includes('AGENT_0008')
              )
            );
            
            let status, emoji;
            if (criticalFailures.length > 0) {
              status = 'BLOCK';
              emoji = 'ðŸš«';
            } else if (failed >= 5) {
              status = 'NEEDS REVIEW';
              emoji = 'âš ï¸';
            } else if (parseFloat(passRate) >= 95) {
              status = 'PASS';
              emoji = 'âœ…';
            } else {
              status = 'NEEDS REVIEW';
              emoji = 'âš ï¸';
            }
            
            let body = `## ${emoji} F.A.I.L. Kit Audit: ${status}\n\n`;
            body += `| Metric | Value |\n|--------|-------|\n`;
            body += `| **Pass Rate** | ${passRate}% (${passed}/${total}) |\n`;
            body += `| **Critical Issues** | ${criticalFailures.length} |\n`;
            body += `| **Node.js** | ${{ matrix.node-version }} |\n`;
            body += `| **Duration** | ${(results.duration_ms / 1000).toFixed(2)}s |\n\n`;
            
            if (failed > 0) {
              body += `<details><summary>View ${failed} failure(s)</summary>\n\n`;
              body += `| Test | Reason |\n|------|--------|\n`;
              for (const f of results.results.filter(r => !r.pass).slice(0, 15)) {
                const reason = (f.reason || f.error || 'Failed').substring(0, 50);
                body += `| \`${f.case}\` | ${reason} |\n`;
              }
              body += `\n</details>\n\n`;
            }
            
            body += `---\n<sub>Generated by F.A.I.L. Kit â€¢ Commit: \`${context.sha.substring(0, 7)}\`</sub>`;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.find(c => 
              c.body.includes('F.A.I.L. Kit Audit') && 
              c.user.type === 'Bot'
            );
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }
            
            // Create check run
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'F.A.I.L. Kit Audit',
              head_sha: context.sha,
              status: 'completed',
              conclusion: status === 'BLOCK' ? 'failure' : status === 'PASS' ? 'success' : 'neutral',
              output: {
                title: `F.A.I.L. Kit: ${status}`,
                summary: `${passed}/${total} tests passed (${passRate}%)`,
              }
            });

      - name: Upload Audit Results
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: fail-audit-results-${{ matrix.node-version }}
          path: |
            audit-results.json
            audit-dashboard.html
          retention-days: 30

      - name: Fail on Critical Issues
        if: steps.audit.outputs.AUDIT_FAILED == 'true'
        run: |
          echo "::error::F.A.I.L. Kit audit detected critical issues"
          exit 1
